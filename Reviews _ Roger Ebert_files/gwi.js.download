(function() {
    function getQueryParam(param) {
        var query = document.location.search.slice(1)
        query = decodeURIComponent(query)
        var keyValuePairs = query.split("&");
        for (var i=0;i<keyValuePairs.length;++i) {
            var pair = keyValuePairs[i].split("=");
            if(pair[0] == param){return pair[1];}
        }
        return null;
    }

    // Check if locale is already set and valid. If not, fetch it.
    var locale = getQueryParam("locale")
    var returningPromise = Promise.resolve(locale)
    if (typeof locale !== "string" || locale.length !== 5 || locale[2] !== "_") {
        returningPromise = Promise.race([fetch("https://checkip.justwatch.com")
            .then(checkipRes => {
                return checkipRes.json()
            }).catch(e => {
                // Fetching the country failed, default to US.
                return {country: "US"}
            }).then(jsonRes => {
                if (!jsonRes.hasOwnProperty("country")) {
                    return "en_US"
                }
                var language = window.navigator.userLanguage || window.navigator.languages[0] || window.navigator.language || "en"
                if (language.length > 2) {
                    language = language.slice(0, 2).toLowerCase()
                }
                if (language.length != 2) {
                    language = "en"
                }
                return language + "_" + jsonRes.country
            }),
            // Set a timeout of 1.5 seconds and default to en_US if it times out.
            new Promise((resolve, reject) => {
                window.setTimeout(() => {
                    resolve("en_US")
                }, 1500)
            })
        ])
    }

    // Load the actual gwi.js script.
    returningPromise
        .then(locale => {
            window.gwiJWLocalePlsDontChange = locale

            var body = document.getElementsByTagName("body")[0];
            var script = document.createElement("script");
            script.type = "text/javascript";
            script.src = "https://superwidget-assets.gowatchit.com/gwigwi.js";
            body.appendChild(script);
        })
})()